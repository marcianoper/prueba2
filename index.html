<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Men√∫ ‚Äî Tacos Paisa Chema</title>

  <style>
    :root{
      /* PALETA tipo la referencia (beige + caf√© + dorado + verde precio) */
      --bg:#f3e7d2;
      --paper:#fbf3e3;
      --paper2:#fff8ea;
      --ink:#2f241d;
      --muted:#6a5647;
      --line:#d8c3a7;

      --gold:#c98a1a;
      --gold2:#b87810;
      --goldGlow: rgba(201,138,26,.35);

      --green:#1f6f2a;

      --nav:#4b3528;
      --nav2:#3b2a20;

      --shadow: 0 24px 70px rgba(29,18,10,.18);
      --r:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 520px at 25% -10%, rgba(201,138,26,.18), transparent 55%),
        radial-gradient(1100px 520px at 90% 10%, rgba(75,53,40,.12), transparent 55%),
        var(--bg);
      color:var(--ink);
    }

    /* HEADER / HERO */
    header{
      position:sticky; top:0; z-index:30;
      background: linear-gradient(180deg, rgba(251,243,227,.95), rgba(251,243,227,.88));
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(216,195,167,.8);
    }
    .topbar{
      max-width:1180px; margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center; min-width:0;
    }
    .brandTitle{
      font-weight:1000; letter-spacing:.2px;
      font-size:18px; line-height:1.1; margin:0;
    }
    .brandSub{font-size:12px; color:var(--muted); margin-top:2px}
    .hero{
      max-width:1180px; margin:0 auto; padding:0 14px 14px;
    }
    .heroCard{
      border:1px solid rgba(216,195,167,.9);
      border-radius:28px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background: #0b1626;
      height: 140px;
      position:relative;
    }
    .heroCard img{
      width:100%; height:100%;
      object-fit:cover;
      opacity:.95;
    }
    .heroOverlay{
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.10));
      display:flex; align-items:flex-end;
      padding:16px;
      color:#fff;
    }
    .heroOverlay b{font-size:22px}
    .heroOverlay span{display:block; opacity:.9; font-size:12px; margin-top:4px}

    /* BUSCADOR + TABS */
    .wrap{
      max-width:1180px; margin:0 auto; padding:14px;
      display:grid; gap:14px;
    }
    .searchRow{
      display:flex; gap:10px; align-items:center;
    }
    .search{
      flex:1;
      background: rgba(255,248,234,.85);
      border:1px solid rgba(216,195,167,.9);
      border-radius:16px;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .tab{
      border:1px solid rgba(216,195,167,.95);
      background: rgba(255,248,234,.8);
      padding:10px 14px;
      border-radius:999px;
      font-weight:950;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      color: var(--nav);
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(75,53,40,.95), rgba(59,42,32,.95));
      color:#fff;
      border-color: rgba(59,42,32,.85);
      box-shadow: 0 10px 22px rgba(59,42,32,.22);
    }

    /* LISTA DE PRODUCTOS (dos columnas, estilo ‚Äútarjeta grande‚Äù) */
    .sectionTitle{
      margin:6px 0 0;
      font-size:44px;
      font-weight:1100;
      letter-spacing:.4px;
      color: rgba(47,36,29,.92);
    }
    .sectionLine{
      height:4px;
      background: rgba(216,195,167,.95);
      border-radius:999px;
      margin:10px 0 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .sectionTitle{font-size:36px}
      .heroCard{height:120px}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,248,234,.95), rgba(251,243,227,.95));
      border:1px solid rgba(216,195,167,.95);
      border-radius:24px;
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(29,18,10,.14);
      display:grid;
      grid-template-columns: 1fr 1.05fr;
      min-height: 170px;
    }
    .cardLeft{
      padding:18px 18px 16px;
      border-right:1px solid rgba(216,195,167,.95);
    }
    .pName{font-size:34px; font-weight:1100; margin:0; line-height:1.05}
    .pDesc{margin:8px 0 0; font-size:18px; color:var(--muted); line-height:1.25}
    .price{
      margin-top:14px;
      font-weight:1100;
      color: var(--green);
      font-size:28px;
      letter-spacing:.3px;
    }
    .price small{font-size:22px; font-weight:1000; margin-right:8px}
    .cardRight{
      padding:14px;
      display:grid;
      grid-template-rows: 1fr auto;
      gap:10px;
      align-items:end;
      justify-items:center;
      background: linear-gradient(180deg, rgba(255,248,234,.75), rgba(255,248,234,.95));
    }
    .photo{
      width:100%;
      height:108px;
      border-radius:18px;
      overflow:hidden;
      background:#0b1626;
      box-shadow: 0 18px 50px rgba(29,18,10,.18);
    }
    .photo img{width:100%; height:100%; object-fit:cover; display:block}
    .btnAdd{
      border:none;
      cursor:pointer;
      padding:12px 26px;
      border-radius:999px;
      font-size:18px;
      font-weight:1100;
      color:#fff;
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      box-shadow: 0 18px 38px var(--goldGlow);
      transition: transform .06s ease;
    }
    .btnAdd:active{transform: translateY(1px)}

    /* BARRA INFERIOR (carrito + continuar) */
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px;
      z-index:40;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.22));
      pointer-events:none;
    }
    .bottomInner{
      max-width:1180px; margin:0 auto;
      background: linear-gradient(180deg, rgba(28,36,45,.96), rgba(21,28,36,.96));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 80px rgba(0,0,0,.35);
      border-radius:14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      pointer-events:auto;
    }
    .barTotal{
      display:flex; align-items:center; gap:12px;
      color:#fff;
      font-weight:1100;
      letter-spacing:.2px;
    }
    .barTotal .money{font-size:20px}
    .barTotal .items{font-size:12px; opacity:.9; font-weight:800}
    .btnContinue{
      border:none;
      cursor:pointer;
      color:#fff;
      font-weight:1100;
      letter-spacing:.6px;
      padding:12px 16px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; gap:10px;
    }
    .btnContinue:active{transform: translateY(1px)}

    /* DRAWER carrito (lista) */
    .drawer{
      position:fixed; inset:0;
      display:none;
      z-index:60;
      background: rgba(0,0,0,.55);
      padding:14px;
      align-items:flex-end;
      justify-content:center;
    }
    .panel{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(255,248,234,.98), rgba(251,243,227,.98));
      border:1px solid rgba(216,195,167,.95);
      border-radius:22px;
      box-shadow: 0 40px 120px rgba(0,0,0,.35);
      overflow:hidden;
      max-height: 86vh;
      display:flex; flex-direction:column;
    }
    .panelHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(216,195,167,.9);
    }
    .panelHead b{font-size:16px}
    .xbtn{
      border:1px solid rgba(216,195,167,.95);
      background: rgba(255,255,255,.7);
      border-radius:12px;
      width:40px; height:40px;
      cursor:pointer;
      font-weight:1100;
    }
    .panelBody{
      padding:12px 16px;
      overflow:auto;
    }
    .line{
      display:flex; justify-content:space-between; gap:12px;
      padding:10px 0;
      border-bottom:1px dashed rgba(216,195,167,.9);
    }
    .line:last-child{border-bottom:none}
    .lName{font-weight:1100}
    .lSub{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.2}
    .qtyBox{
      display:flex; gap:8px; align-items:center;
    }
    .mini{
      width:32px; height:32px;
      border-radius:10px;
      border:1px solid rgba(216,195,167,.95);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:1100;
    }
    .trash{
      margin-left:8px;
      border:none;
      background: rgba(184,54,54,.12);
      border:1px solid rgba(184,54,54,.30);
      color:#8a1c1c;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
    }
    .panelFoot{
      padding:14px 16px;
      border-top:1px solid rgba(216,195,167,.9);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: rgba(255,248,234,.9);
    }
    .panelFoot .sum{font-weight:1100}
    .btnPrimary{
      border:none; cursor:pointer;
      color:#fff; font-weight:1100;
      padding:12px 16px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(28,36,45,.96), rgba(21,28,36,.96));
      border:1px solid rgba(0,0,0,.15);
    }

    /* CHECKOUT POR PASOS */
    .checkout{
      position:fixed; inset:0;
      display:none;
      z-index:80;
      background: rgba(0,0,0,.55);
      padding:14px;
      align-items:flex-end;
      justify-content:center;
    }
    .checkoutPanel{
      width:min(980px, 100%);
      max-height: 90vh;
      overflow:hidden;
      border-radius:22px;
      box-shadow: 0 50px 140px rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.10);
      background:#fff;
      display:flex; flex-direction:column;
    }
    .cHead{
      padding:14px 16px;
      border-bottom:1px solid #e5e7eb;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: #fff;
    }
    .cHead .title{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .cHead .title b{font-size:16px}
    .cHead .title span{font-size:12px; color:#64748b}

    .steps{
      padding:12px 16px;
      border-bottom:1px solid #e5e7eb;
      display:flex; gap:10px; flex-wrap:wrap;
      background: #f8fafc;
    }
    .stepPill{
      padding:8px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
      display:flex; gap:8px; align-items:center;
    }
    .stepPill.active{
      border-color: rgba(30,41,59,.35);
      box-shadow: 0 0 0 3px rgba(30,41,59,.08);
    }

    .cBody{
      padding:14px 16px;
      overflow:auto;
      background:#fff;
    }
    .box{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px;
      background:#fff;
      margin-bottom:12px;
    }
    .box h3{margin:0 0 10px; font-size:14px}
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){ .row2{grid-template-columns:1fr} }
    label{
      display:block;
      font-size:12px;
      font-weight:1000;
      color:#0f172a;
      margin:10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    textarea{min-height:88px; resize:vertical}

    .tipGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:720px){ .tipGrid{grid-template-columns: repeat(2, 1fr)} }
    .tipBtn{
      padding:12px 10px;
      border-radius:12px;
      border:2px solid #0f172a;
      background:#fff;
      font-weight:1100;
      cursor:pointer;
    }
    .tipBtn.active{
      background:#1f2a37;
      color:#fff;
      border-color:#1f2a37;
    }

    .couponRow{
      display:flex; gap:10px; align-items:center;
    }
    .applyBtn{
      padding:12px 14px;
      border-radius:12px;
      border:none;
      background:#9ca3af;
      color:#fff;
      font-weight:1100;
      cursor:not-allowed;
      min-width:120px;
    }

    .payRow{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .radio{
      display:flex; gap:10px; align-items:center;
      padding:12px 12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      cursor:pointer;
      min-width:180px;
      user-select:none;
    }
    .dot{
      width:18px; height:18px; border-radius:999px;
      border:2px solid #0f172a;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .dot::after{
      content:"";
      width:10px; height:10px; border-radius:999px;
      background:#0f172a;
      opacity:0;
    }
    .radio.active .dot::after{opacity:1}

    .stickySend{
      position:sticky; bottom:0;
      padding:12px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,1));
      border-top:1px solid #e5e7eb;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .bigSend{
      border:none; cursor:pointer;
      background: linear-gradient(180deg, rgba(28,36,45,.96), rgba(21,28,36,.96));
      color:#fff;
      font-weight:1200;
      letter-spacing:.6px;
      padding:14px 16px;
      border-radius:12px;
      display:flex; align-items:center; gap:10px;
      min-width:220px;
      justify-content:center;
    }
    .ghost{
      border:none; cursor:pointer;
      background: rgba(15,23,42,.06);
      color:#0f172a;
      font-weight:1100;
      padding:14px 16px;
      border-radius:12px;
    }

    /* Separaci√≥n para no tapar con bottom bar */
    .spacer{height:90px}
  </style>
</head>

<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div style="min-width:0">
        <p class="brandTitle">üåÆ Men√∫ Tacos Paisa Chema</p>
        <div class="brandSub">Pedidos r√°pidos ‚Ä¢ estilo Plick ‚Ä¢ WhatsApp</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <div style="font-weight:1100; color:var(--nav); font-size:12px">Abierto</div>
    </div>
  </div>

  <div class="hero">
    <div class="heroCard">
      <!-- Tu imagen grande de men√∫ -->
      <img src="menu.png" alt="Men√∫"/>
      <div class="heroOverlay">
        <div>
          <b>¬°Tacoman√≠a!</b>
          <span>Arma tu pedido y env√≠alo por WhatsApp en 3 pasos.</span>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="searchRow">
    <input class="search" id="q" placeholder="Buscar un producto (taco, gringa, coca, etc.)"/>
  </div>

  <div class="tabs" id="tabs"></div>

  <div>
    <div class="sectionTitle" id="sectionTitle">PROMOS</div>
    <div class="sectionLine"></div>
  </div>

  <section class="grid" id="grid"></section>

  <div class="spacer"></div>
</main>

<!-- Bottom bar -->
<div class="bottomBar">
  <div class="bottomInner">
    <div class="barTotal">
      <div class="money" id="barMoney">$0.00</div>
      <div class="items" id="barItems">0 productos</div>
    </div>
    <button class="btnContinue" id="openCartBtn">üõí VER CARRITO</button>
  </div>
</div>

<!-- Drawer carrito -->
<div class="drawer" id="drawer">
  <div class="panel">
    <div class="panelHead">
      <b>Productos agregados</b>
      <button class="xbtn" id="closeDrawer">‚úï</button>
    </div>

    <div class="panelBody" id="cartList"></div>

    <div class="panelFoot">
      <div class="sum">Total: <span id="drawerTotal">$0.00</span></div>
      <div style="display:flex; gap:10px; align-items:center">
        <button class="btnPrimary" id="clearCart">Vaciar</button>
        <button class="btnPrimary" id="goCheckout">CONTINUAR</button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout 3 pasos -->
<div class="checkout" id="checkout">
  <div class="checkoutPanel">
    <div class="cHead">
      <div class="title">
        <b>Checkout</b>
        <span id="stepLabel">Paso 1 de 3</span>
      </div>
      <button class="xbtn" id="closeCheckout">‚úï</button>
    </div>

    <div class="steps">
      <div class="stepPill" id="pill1">üë§ Paso 1: Datos</div>
      <div class="stepPill" id="pill2">üöö Paso 2: Entrega</div>
      <div class="stepPill" id="pill3">üí≥ Paso 3: Pago</div>
    </div>

    <div class="cBody" id="cBody"></div>

    <div class="stickySend">
      <button class="ghost" id="backBtn">Regresar</button>
      <div style="font-weight:1100">Total: <span id="cTotal">$0.00</span></div>
      <button class="bigSend" id="nextBtn">CONTINUAR</button>
    </div>
  </div>
</div>

<script>
  /** =========================
   * CONFIG
   * ========================= */
  const TAQUERIA_NOMBRE = "Tacos Paisa Chema";
  const WHATSAPP_TAQ = "524621872594"; // tu n√∫mero destino (sin +)

  /** =========================
   * CAT√ÅLOGO (con nombres de im√°genes EXACTOS)
   * ========================= */
  const catalogo = [
    // PROMOS
    {id:"promo_taco_refresco", cat:"PROMOS", name:"Promo Taco + Refresco", price:18, desc:"Solo por hoy, pasa a echar unos.", img:"promo_taco_refresco.png"},
    {id:"promo_2gringas", cat:"PROMOS", name:"Promo 2 Gringas", price:120, desc:"Para compartir bien a gusto.", img:"promo_2gringas.png"},
    {id:"combo_bebidas", cat:"PROMOS", name:"Combo Bebidas", price:85, desc:"Ahorra en refrescos y agua.", img:"combo_bebidas.png"},

    // TACOS
    {id:"taco_1", cat:"TACOS", name:"Taco", price:18, desc:"Tortilla de ma√≠z o harina, elige la carne", img:"taco_1.png"},
    {id:"taco_doble", cat:"TACOS", name:"Taco doble", price:28, desc:"Doble tortilla para m√°s tacos ‚Äî elige la carne", img:"taco_doble.png"},
    {id:"orden_5_tacos", cat:"TACOS", name:"Orden 5 tacos", price:85, desc:"Ideal para no batallar", img:"orden_5_tacos.png"},

    // GRINGAS
    {id:"gringa", cat:"GRINGAS", name:"Gringa", price:70, desc:"Tortilla de harina, queso y carne a elegir", img:"gringa.png"},

    // VOLCANES
    {id:"volcan", cat:"VOLCANES", name:"Volc√°n", price:45, desc:"Tostada + queso + carne a elegir", img:"volcan.png"},
    {id:"volcan_doble", cat:"VOLCANES", name:"Volc√°n doble", price:65, desc:"Tostada + doble queso", img:"volcan_doble.png"},

    // TORTAS
    {id:"torta", cat:"TORTAS", name:"Torta", price:75, desc:"Bolillo relleno con la carne de tu elecci√≥n", img:"torta.png"},
    {id:"torta_especial", cat:"TORTAS", name:"Torta especial", price:89, desc:"Con queso y extras", img:"torta_especial.png"},

    // BEBIDAS
    {id:"coca_600ml", cat:"BEBIDAS", name:"Coca 600ml", price:25, desc:"Bien fr√≠a", img:"coca_600ml.png"},
    {id:"agua_fresca", cat:"BEBIDAS", name:"Agua fresca 1/2L", price:30, desc:"Del d√≠a", img:"agua_fresca.png"},

    // EXTRAS
    {id:"queso_extra", cat:"EXTRAS", name:"Queso extra", price:10, desc:"Agr√©galo a tu pedido", img:"queso_extra.png"},
    {id:"aguacate_extra", cat:"EXTRAS", name:"Aguacate extra", price:10, desc:"Para que quede fino", img:"aguacate_extra.png"},
    {id:"cebollitas", cat:"EXTRAS", name:"Cebollitas", price:10, desc:"Doraditas", img:"cebollitas.png"},

    // (Opcional: fotos decorativas que ya tienes)
    // {id:"tacos_1", cat:"TACOS", name:"Foto tacos 1", price:0, desc:"", img:"tacos_1.png"},
    // {id:"tacos_2", cat:"TACOS", name:"Foto tacos 2", price:0, desc:"", img:"tacos_2.png"},
    // {id:"quesadilla", cat:"GRINGAS", name:"Quesadilla", price:35, desc:"Tortilla de ma√≠z, queso y carne a elegir", img:"quesadilla.png"},
  ];

  const cats = ["PROMOS","TACOS","GRINGAS","VOLCANES","TORTAS","BEBIDAS","EXTRAS"];

  /** =========================
   * HELPERS
   * ========================= */
  const money = n => "$" + (Math.round(n*100)/100).toFixed(2);

  /** =========================
   * STATE
   * ========================= */
  let activeCat = "PROMOS";
  let query = "";
  let cart = []; // {id, name, price, qty}

  // checkout state
  let step = 1;
  let checkoutState = {
    nombre: "",
    tel: "",
    pais: "mx",
    canal: "domicilio", // domicilio | recoger | aqui
    calle: "",
    noext: "",
    noint: "",
    colonia: "",
    ciudad: "Irapuato",
    cp: "",
    estado: "Guanajuato",
    paisTxt: "M√©xico",
    refs: "",
    tipPct: 0,
    cupon: "",
    pagoMetodo: "efectivo",
    pagareCon: ""
  };

  /** =========================
   * UI refs
   * ========================= */
  const tabsEl = document.getElementById("tabs");
  const gridEl = document.getElementById("grid");
  const sectionTitleEl = document.getElementById("sectionTitle");
  const qEl = document.getElementById("q");

  const barMoney = document.getElementById("barMoney");
  const barItems = document.getElementById("barItems");

  const drawer = document.getElementById("drawer");
  const cartList = document.getElementById("cartList");
  const drawerTotal = document.getElementById("drawerTotal");

  const checkout = document.getElementById("checkout");
  const cBody = document.getElementById("cBody");
  const stepLabel = document.getElementById("stepLabel");
  const cTotal = document.getElementById("cTotal");

  const pill1 = document.getElementById("pill1");
  const pill2 = document.getElementById("pill2");
  const pill3 = document.getElementById("pill3");

  const backBtn = document.getElementById("backBtn");
  const nextBtn = document.getElementById("nextBtn");

  /** =========================
   * CART helpers
   * ========================= */
  function cartCount(){ return cart.reduce((a,x)=>a+x.qty,0); }
  function cartSubtotal(){ return cart.reduce((a,x)=>a + x.qty*x.price, 0); }
  function cartTipAmount(){
    return cartSubtotal() * (checkoutState.tipPct/100);
  }
  function cartTotal(){
    return cartSubtotal() + cartTipAmount();
  }

  function addToCart(item){
    const line = cart.find(x=>x.id===item.id);
    if(line) line.qty += 1;
    else cart.push({id:item.id, name:item.name, price:item.price, qty:1});
    renderBottom();
  }

  function inc(id){
    const line = cart.find(x=>x.id===id);
    if(line){ line.qty += 1; renderDrawer(); renderBottom(); }
  }
  function dec(id){
    const line = cart.find(x=>x.id===id);
    if(line){ line.qty = Math.max(1, line.qty-1); renderDrawer(); renderBottom(); }
  }
  function removeLine(id){
    cart = cart.filter(x=>x.id!==id);
    renderDrawer(); renderBottom();
  }

  /** =========================
   * RENDER tabs + grid
   * ========================= */
  function renderTabs(){
    tabsEl.innerHTML = "";
    cats.forEach(c=>{
      const t = document.createElement("div");
      t.className = "tab" + (c===activeCat ? " active":"");
      t.textContent = c;
      t.onclick = ()=>{ activeCat=c; renderTabs(); renderGrid(); };
      tabsEl.appendChild(t);
    });
  }

  function renderGrid(){
    sectionTitleEl.textContent = activeCat;
    const list = catalogo.filter(p=>{
      const okCat = p.cat === activeCat;
      const okQ = !query || (p.name.toLowerCase().includes(query) || (p.desc||"").toLowerCase().includes(query));
      return okCat && okQ;
    });

    gridEl.innerHTML = "";
    list.forEach(p=>{
      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <div class="cardLeft">
          <h3 class="pName">${escapeHtml(p.name)}</h3>
          <div class="pDesc">${escapeHtml(p.desc||"")}</div>
          <div class="price"><small>MXN</small>${money(p.price)}</div>
        </div>
        <div class="cardRight">
          <div class="photo">
            <img src="${escapeAttr(p.img)}" alt="${escapeAttr(p.name)}" onerror="this.style.opacity=.15; this.alt='(Falta imagen)';"/>
          </div>
          <button class="btnAdd" data-id="${escapeAttr(p.id)}">Agregar</button>
        </div>
      `;
      card.querySelector(".btnAdd").onclick = ()=> addToCart(p);
      gridEl.appendChild(card);
    });
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function escapeAttr(s){
    return (s||"").replaceAll('"',"&quot;");
  }

  /** =========================
   * Bottom bar
   * ========================= */
  function renderBottom(){
    barMoney.textContent = money(cartSubtotal());
    barItems.textContent = `${cartCount()} productos`;
  }

  /** =========================
   * Drawer carrito
   * ========================= */
  function openDrawer(){
    renderDrawer();
    drawer.style.display = "flex";
  }
  function closeDrawer(){
    drawer.style.display = "none";
  }

  function renderDrawer(){
    if(cart.length===0){
      cartList.innerHTML = `<div style="color:var(--muted); padding:10px 0">A√∫n no agregas nada üòÑ</div>`;
      drawerTotal.textContent = money(0);
      return;
    }
    cartList.innerHTML = "";
    cart.forEach(x=>{
      const row = document.createElement("div");
      row.className = "line";
      row.innerHTML = `
        <div style="min-width:0">
          <div class="lName">${escapeHtml(x.name)}</div>
          <div class="lSub">${x.qty} x ${money(x.price)} = <b>${money(x.qty*x.price)}</b></div>
        </div>
        <div style="text-align:right">
          <div class="qtyBox">
            <button class="mini">‚àí</button>
            <div style="min-width:26px; text-align:center; font-weight:1100">${x.qty}</div>
            <button class="mini">+</button>
            <button class="trash">üóë</button>
          </div>
        </div>
      `;
      const minis = row.querySelectorAll(".mini");
      minis[0].onclick = ()=> dec(x.id);
      minis[1].onclick = ()=> inc(x.id);
      row.querySelector(".trash").onclick = ()=> removeLine(x.id);
      cartList.appendChild(row);
    });

    drawerTotal.textContent = money(cartSubtotal());
  }

  /** =========================
   * Checkout (3 pasos)
   * ========================= */
  function openCheckout(){
    if(cart.length===0){ alert("Agrega productos al carrito primero üòÑ"); return; }
    step = 1;
    renderCheckout();
    checkout.style.display = "flex";
  }
  function closeCheckout(){
    checkout.style.display = "none";
  }

  function setActivePills(){
    [pill1,pill2,pill3].forEach(p=>p.classList.remove("active"));
    if(step===1) pill1.classList.add("active");
    if(step===2) pill2.classList.add("active");
    if(step===3) pill3.classList.add("active");
  }

  function renderCheckout(){
    stepLabel.textContent = `Paso ${step} de 3`;
    cTotal.textContent = money(cartTotal());
    setActivePills();

    if(step===1){
      nextBtn.textContent = "CONTINUAR";
      backBtn.textContent = "Regresar";
      cBody.innerHTML = `
        <div class="box">
          <h3>Datos personales</h3>
          <label>Nombre *</label>
          <input id="c_nombre" placeholder="Ej. Marciano P√©rez" value="${escapeAttr(checkoutState.nombre)}"/>
          <div class="row2">
            <div>
              <label>C√≥digo de pa√≠s</label>
              <select id="c_pais">
                <option value="mx">mx üá≤üáΩ +52</option>
              </select>
            </div>
            <div>
              <label>N√∫mero de celular *</label>
              <input id="c_tel" placeholder="Ej. 4621234567" value="${escapeAttr(checkoutState.tel)}"/>
            </div>
          </div>
        </div>
      `;

      document.getElementById("c_nombre").oninput = e=> checkoutState.nombre = e.target.value;
      document.getElementById("c_tel").oninput = e=> checkoutState.tel = e.target.value;
      return;
    }

    if(step===2){
      nextBtn.textContent = "CONTINUAR";
      backBtn.textContent = "Regresar";

      cBody.innerHTML = `
        <div class="box">
          <h3>Agregar direcci√≥n de entrega</h3>

          <label>¬øC√≥mo lo quieres?</label>
          <select id="c_canal">
            <option value="domicilio">Enviar a domicilio</option>
            <option value="recoger">Pasar a recoger</option>
            <option value="aqui">Comer aqu√≠</option>
          </select>

          <div id="addrBox" style="margin-top:10px; display:none">
            <div class="box" style="margin:10px 0 0; background:#f8fafc">
              <h3 style="margin:0 0 10px">Ubicaci√≥n</h3>
              <button class="btnPrimary" id="openMaps" type="button" style="width:100%">Seleccionar la ubicaci√≥n de env√≠o (Maps)</button>
              <div style="font-size:12px; color:#64748b; margin-top:8px">
                * Abre Google Maps para copiar/pegar tu ubicaci√≥n o referencia.
              </div>
            </div>

            <label>Calle *</label>
            <input id="c_calle" value="${escapeAttr(checkoutState.calle)}" placeholder="Ej. Calle Uni√≥n"/>

            <div class="row2">
              <div>
                <label>No. Exterior *</label>
                <input id="c_noext" value="${escapeAttr(checkoutState.noext)}" placeholder="Ej. 678"/>
              </div>
              <div>
                <label>No. Interior</label>
                <input id="c_noint" value="${escapeAttr(checkoutState.noint)}" placeholder="Departamento, casa, etc."/>
              </div>
            </div>

            <label>Colonia *</label>
            <input id="c_col" value="${escapeAttr(checkoutState.colonia)}" placeholder="Ej. Las Plazas"/>

            <div class="row2">
              <div>
                <label>Ciudad *</label>
                <input id="c_city" value="${escapeAttr(checkoutState.ciudad)}" placeholder="Ej. Irapuato"/>
              </div>
              <div>
                <label>CP *</label>
                <input id="c_cp" value="${escapeAttr(checkoutState.cp)}" placeholder="Ej. 36580"/>
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Estado *</label>
                <input id="c_state" value="${escapeAttr(checkoutState.estado)}" placeholder="Ej. Guanajuato"/>
              </div>
              <div>
                <label>Pa√≠s</label>
                <input id="c_country" value="${escapeAttr(checkoutState.paisTxt)}" disabled/>
              </div>
            </div>

            <label>Referencias</label>
            <textarea id="c_refs" placeholder="Entre calles, color de la casa, etc.">${escapeHtml(checkoutState.refs||"")}</textarea>
          </div>
        </div>
      `;

      const canalSel = document.getElementById("c_canal");
      canalSel.value = checkoutState.canal;

      const addrBox = document.getElementById("addrBox");
      function syncAddrVisible(){
        addrBox.style.display = (checkoutState.canal === "domicilio") ? "block" : "none";
      }
      canalSel.onchange = e=>{
        checkoutState.canal = e.target.value;
        syncAddrVisible();
      };
      syncAddrVisible();

      const openMapsBtn = document.getElementById("openMaps");
      if(openMapsBtn){
        openMapsBtn.onclick = ()=>{
          // Abre maps centrado en Irapuato (simple, sin API)
          window.open("https://www.google.com/maps/search/?api=1&query=Irapuato%2C+Guanajuato", "_blank");
        };
      }

      // bind inputs si existen (domicilio)
      const bind = (id, key)=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.oninput = e=> checkoutState[key] = e.target.value;
      };
      bind("c_calle","calle");
      bind("c_noext","noext");
      bind("c_noint","noint");
      bind("c_col","colonia");
      bind("c_city","ciudad");
      bind("c_cp","cp");
      bind("c_state","estado");
      const refs = document.getElementById("c_refs");
      if(refs) refs.oninput = e=> checkoutState.refs = e.target.value;

      return;
    }

    if(step===3){
      nextBtn.textContent = "ENVIAR PEDIDO";
      backBtn.textContent = "Regresar";

      cBody.innerHTML = `
        <div class="box">
          <h3>Propina</h3>
          <div class="tipGrid" id="tipGrid">
            ${[0,5,10,15,20,30,40,50].map(p=>`
              <button class="tipBtn ${checkoutState.tipPct===p?'active':''}" data-tip="${p}">${p}%</button>
            `).join("")}
          </div>
        </div>

        <div class="box">
          <h3>Cup√≥n de descuento</h3>
          <div class="couponRow">
            <input id="c_cupon" placeholder="C√≥digo del cup√≥n" value="${escapeAttr(checkoutState.cupon)}"/>
            <button class="applyBtn" type="button">Aplicar</button>
          </div>
          <div style="font-size:12px; color:#64748b; margin-top:8px">
            (MVP: el cup√≥n a√∫n no aplica descuento, es solo visual)
          </div>
        </div>

        <div class="box">
          <h3>Detalle del pedido</h3>
          <div style="display:grid; gap:8px; font-size:14px">
            <div style="display:flex; justify-content:space-between"><span>Total del pedido:</span><b>${money(cartSubtotal())}</b></div>
            <div style="display:flex; justify-content:space-between"><span>Propina (${checkoutState.tipPct}%):</span><b>${money(cartTipAmount())}</b></div>
            <div style="display:flex; justify-content:space-between; padding:10px 12px; background:#eef2f7; border-radius:12px">
              <span style="font-weight:1000">Total a pagar:</span><b style="font-size:16px">${money(cartTotal())}</b>
            </div>
          </div>
        </div>

        <div class="box">
          <h3>M√©todo de pago</h3>
          <div class="payRow">
            <div class="radio active" id="pay_cash">
              <div class="dot"></div>
              <div>
                <div style="font-weight:1100">Efectivo</div>
                <div style="font-size:12px; color:#64748b">Pagar√© con‚Ä¶</div>
              </div>
            </div>
          </div>

          <label>Pagar√© con (monto) *</label>
          <input id="c_pagare" placeholder="Ej. 500" value="${escapeAttr(checkoutState.pagareCon)}"/>
        </div>
      `;

      // tip buttons
      document.getElementById("tipGrid").querySelectorAll(".tipBtn").forEach(b=>{
        b.onclick = ()=>{
          checkoutState.tipPct = Number(b.dataset.tip);
          renderCheckout();
        };
      });

      document.getElementById("c_cupon").oninput = e=> checkoutState.cupon = e.target.value;
      document.getElementById("c_pagare").oninput = e=> { checkoutState.pagareCon = e.target.value; };

      return;
    }
  }

  function validateStep(){
    if(step===1){
      if(!checkoutState.nombre.trim()) return "Escribe tu nombre.";
      const t = checkoutState.tel.replace(/\D/g,"");
      if(t.length < 10) return "Escribe un n√∫mero de celular v√°lido (10 d√≠gitos).";
    }
    if(step===2 && checkoutState.canal==="domicilio"){
      if(!checkoutState.calle.trim()) return "Falta la calle.";
      if(!checkoutState.noext.trim()) return "Falta el n√∫mero exterior.";
      if(!checkoutState.colonia.trim()) return "Falta la colonia.";
      if(!checkoutState.ciudad.trim()) return "Falta la ciudad.";
      if(!checkoutState.cp.trim()) return "Falta el CP.";
      if(!checkoutState.estado.trim()) return "Falta el estado.";
    }
    if(step===3){
      if(!String(checkoutState.pagareCon||"").trim()) return "Pon con cu√°nto vas a pagar (monto).";
    }
    return null;
  }

  function buildWhatsAppText(){
    const canalTxt = checkoutState.canal==="domicilio" ? "Env√≠o a domicilio" :
                     checkoutState.canal==="recoger" ? "Pasar a recoger" : "Comer aqu√≠";

    const telFull = "+52" + checkoutState.tel.replace(/\D/g,"");

    const lines = [];
    lines.push(`*${TAQUERIA_NOMBRE}*`);
    lines.push(`${checkoutState.nombre}, este es tu pedido:`);
    lines.push(``);
    lines.push(`Canal: *${canalTxt}*`);
    lines.push(`Contacto: ${telFull}`);

    if(checkoutState.canal==="domicilio"){
      lines.push(`Domicilio para la entrega:`);
      lines.push(`  Calle: ${checkoutState.calle} #${checkoutState.noext}${checkoutState.noint?(" Int. "+checkoutState.noint):""}`);
      lines.push(`  Colonia: ${checkoutState.colonia}`);
      lines.push(`  Ciudad: ${checkoutState.ciudad}, ${checkoutState.estado}`);
      lines.push(`  CP: ${checkoutState.cp}`);
      if(checkoutState.refs.trim()) lines.push(`  Referencias: ${checkoutState.refs.trim()}`);
    }

    lines.push(``);
    lines.push(`--------------------------`);
    cart.forEach(x=>{
      lines.push(`‚Ä¢ ${x.qty} x ${x.name} ‚Äî ${money(x.price)}`);
    });
    lines.push(`--------------------------`);

    lines.push(`SubTotal: ${money(cartSubtotal())}`);
    lines.push(`Propina: ${checkoutState.tipPct}% (${money(cartTipAmount())})`);
    lines.push(`Total: *${money(cartTotal())}*`);
    lines.push(``);
    lines.push(`Pagar√© con: *$${checkoutState.pagareCon}* en Efectivo`);
    lines.push(``);
    lines.push(`${checkoutState.nombre}, tu pedido se est√° preparando con amor. üß°üë®‚Äçüç≥`);
    lines.push(`#plick (MVP)`);

    return lines.join("\n");
  }

  function sendWhatsApp(){
    const text = buildWhatsAppText();
    const url = `https://wa.me/${WHATSAPP_TAQ}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  /** =========================
   * EVENTS
   * ========================= */
  qEl.oninput = e=>{
    query = (e.target.value||"").toLowerCase().trim();
    renderGrid();
  };

  document.getElementById("openCartBtn").onclick = openDrawer;
  document.getElementById("closeDrawer").onclick = closeDrawer;
  drawer.addEventListener("click", e=>{ if(e.target===drawer) closeDrawer(); });

  document.getElementById("clearCart").onclick = ()=>{
    if(confirm("¬øVaciar carrito?")){
      cart = [];
      renderDrawer();
      renderBottom();
      closeDrawer();
    }
  };

  document.getElementById("goCheckout").onclick = ()=>{
    if(cart.length===0){ alert("Tu carrito est√° vac√≠o."); return; }
    closeDrawer();
    openCheckout();
  };

  document.getElementById("closeCheckout").onclick = closeCheckout;
  checkout.addEventListener("click", e=>{ if(e.target===checkout) closeCheckout(); });

  backBtn.onclick = ()=>{
    if(step===1){
      closeCheckout();
      openDrawer();
      return;
    }
    step = Math.max(1, step-1);
    renderCheckout();
  };

  nextBtn.onclick = ()=>{
    const err = validateStep();
    if(err){ alert(err); return; }

    if(step < 3){
      step += 1;
      renderCheckout();
      return;
    }

    // step 3 -> enviar
    sendWhatsApp();
  };

  // allow clicking pills
  pill1.onclick = ()=>{ step=1; renderCheckout(); };
  pill2.onclick = ()=>{ step=2; renderCheckout(); };
  pill3.onclick = ()=>{ step=3; renderCheckout(); };

  /** =========================
   * INIT
   * ========================= */
  renderTabs();
  renderGrid();
  renderBottom();
</script>

</body>
</html>
