<input id="qrInput" placeholder="Escanea aquí el QR..." style="width:100%;padding:14px;font-size:18px">
<select id="clienteSelect"></select>
<div id="msg"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "TU_URL";
const SUPABASE_KEY = "TU_ANON_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const qrInput = document.getElementById("qrInput");
const msg = document.getElementById("msg");
const clienteSelect = document.getElementById("clienteSelect");

// 1) Carga clientes (ajusta tabla/campos)
async function cargarClientes(){
  const { data, error } = await sb.from("clientes").select("id,nombre").order("nombre");
  if(error){ msg.textContent = error.message; return; }
  clienteSelect.innerHTML = data.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join("");
}
cargarClientes();

// 2) Maneja escaneo (Enter)
qrInput.addEventListener("keydown", async (e)=>{
  if(e.key !== "Enter") return;
  const payload = qrInput.value.trim();
  qrInput.value = "";

  const cliente_id = clienteSelect.value;
  if(!cliente_id){ msg.textContent = "Selecciona un cliente."; return; }

  let items;
  try{
    items = JSON.parse(payload); // tu QR trae un array JSON
    if(!Array.isArray(items)) throw new Error("El QR no trae un arreglo de items.");
  }catch(err){
    msg.textContent = "QR inválido: " + err.message;
    return;
  }

  // Limpieza ligera
  items = items.map(x => ({
    producto: (x.producto || "").trim(),
    cantidad: String(x.cantidad || "0").trim()
  }));

  msg.textContent = "Registrando venta...";

  const { data, error } = await sb.rpc("registrar_venta_descontar_inventario", {
    p_cliente_id: cliente_id,
    p_items: items
  });

  if(error){
    msg.textContent = "❌ " + error.message;
    return;
  }

  msg.textContent = "✅ Venta registrada. ID: " + data;
});
</script>
