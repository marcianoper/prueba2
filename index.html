<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VDC 360° — Inventario Mostrador (MVP)</title>
  <style>
    :root{
      --brand:#0a7a3b;
      --brand2:#0f9a52;
      --bg:#f6f7f8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --danger:#b91c1c;
      --shadow:0 18px 50px rgba(2,6,23,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 500px at 18% -10%, rgba(15,154,82,.18), transparent 60%),
        radial-gradient(800px 420px at 92% 0%, rgba(10,122,59,.14), transparent 55%),
        var(--bg);
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
      padding:14px 16px;
      box-shadow:0 10px 24px rgba(2,6,23,.12);
    }
    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      max-width:1200px; margin:0 auto;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand b{font-size:16px; letter-spacing:.2px}
    .brand small{opacity:.9}
    .pill{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px;
    }
    .pill span{
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.25);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }
    main{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      gap:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .muted{color:var(--muted)}
    .row{display:grid; gap:10px}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:600px){ .row2{grid-template-columns:1fr} }
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(15,154,82,.55);
      box-shadow: 0 0 0 4px rgba(15,154,82,.12);
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:0;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      width:auto;
    }
    .btn{
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
    }
    .btn2{
      background:#111827;
      color:#fff;
    }
    .btnDanger{
      background:var(--danger);
      color:#fff;
    }
    .btnGhost{
      background:#fff;
      border:1px solid var(--line);
      color:var(--ink);
    }
    .mini{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#f8fafc;
      color:#0f172a;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.6px;
    }
    tr:last-child td{border-bottom:0}
    .right{text-align:right}
    .tag{
      display:inline-block;
      font-size:11px;
      font-weight:800;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
    }
    .tagIn{border-color: rgba(15,154,82,.35); background: rgba(15,154,82,.08); color: var(--brand)}
    .tagOut{border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.08); color: var(--danger)}
    .tagAdj{border-color: rgba(2,6,23,.22); background: rgba(2,6,23,.06); color:#111827}
    .flex{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .search{
      display:flex; gap:10px; flex-wrap:wrap; align-items:end;
    }
    .hint{
      background:#f8fafc;
      border:1px dashed var(--line);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      color:var(--muted);
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 10px 28px rgba(2,6,23,.18);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      max-width:92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1}
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 760px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .kpi .box b{font-size:16px}
    .kpi .box small{color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:14px 0}
    .dangerText{color:var(--danger); font-weight:800}
  </style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand">
      <b>VDC 360° — Inventario Mostrador</b>
      <small>Entradas / Ventas / Devoluciones · MVP local (sin Supabase)</small>
    </div>
    <div class="pill">
      <span id="todayPill">Fecha: —</span>
      <span id="lastSavePill">Último guardado: —</span>
    </div>
  </div>
</header>

<main>

  <div class="grid">

    <!-- LEFT: INVENTARIO + ACCIONES -->
    <section class="card">
      <div class="flex">
        <div>
          <h2>Inventario actual (Mostrador)</h2>
          <div class="muted">Aquí se refleja lo que está en mostrador. Las <b>Ventas</b> restan, las <b>Devoluciones</b> suman.</div>
        </div>
        <div class="btns">
          <button class="btnGhost mini" id="btnDemo">Cargar demo</button>
          <button class="btnDanger mini" id="btnReset">Borrar todo</button>
        </div>
      </div>

      <div class="kpi">
        <div class="box">
          <small>Productos con existencia</small><br>
          <b id="kpiSkus">0</b>
        </div>
        <div class="box">
          <small>Total cajas (solo unidad=caja)</small><br>
          <b id="kpiCajas">0</b>
        </div>
        <div class="box">
          <small>Movimientos hoy</small><br>
          <b id="kpiMovs">0</b>
        </div>
      </div>

      <div class="divider"></div>

      <div class="search">
        <div style="flex:1; min-width:220px">
          <label>Buscar producto</label>
          <input id="searchInput" placeholder="Ej. Menudo National, Caja Excel, Cabeza..."/>
        </div>
        <div style="min-width:170px">
          <label>Filtrar unidad</label>
          <select id="unitFilter">
            <option value="">Todas</option>
            <option value="caja">Caja</option>
            <option value="kg">Kg</option>
            <option value="pza">Pza</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Unidad</th>
              <th class="right">Existencia</th>
              <th class="right">Acción rápida</th>
            </tr>
          </thead>
          <tbody id="invTbody">
            <tr><td colspan="4" class="muted">Sin datos aún. Registra una entrada o carga demo.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hint" style="margin-top:12px">
        Tip: Para cajas de menudo, usa <b>unidad=caja</b>. Para víscera por peso, usa <b>unidad=kg</b>. Si vendes en mostrador por pieza, usa <b>unidad=pza</b>.
      </div>
    </section>

    <!-- RIGHT: REGISTRAR MOVIMIENTO -->
    <aside class="card">
      <h2>Registrar movimiento</h2>
      <div class="muted">Esto alimenta el kardex y actualiza inventario automático.</div>

      <div class="divider"></div>

      <div class="row">
        <div class="row2">
          <div>
            <label>Fecha</label>
            <input id="fecha" type="date"/>
          </div>
          <div>
            <label>Tipo</label>
            <select id="tipo">
              <option value="entrada">Entrada (mandas a mostrador)</option>
              <option value="venta">Venta (resta)</option>
              <option value="devolucion">Devolución (suma)</option>
              <option value="ajuste">Ajuste (manual)</option>
            </select>
          </div>
        </div>

        <div>
          <label>Producto</label>
          <input id="producto" placeholder="Ej. Caja Menudo National"/>
        </div>

        <div class="row2">
          <div>
            <label>Unidad</label>
            <select id="unidad">
              <option value="caja">Caja</option>
              <option value="kg">Kg</option>
              <option value="pza">Pza</option>
            </select>
          </div>
          <div>
            <label>Cantidad</label>
            <input id="qty" type="number" step="0.01" min="0" placeholder="Ej. 5"/>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Referencia (opcional)</label>
            <input id="ref" placeholder="Ej. Ticket 123, Cliente X, Turno AM"/>
          </div>
          <div>
            <label>Notas (opcional)</label>
            <input id="notas" placeholder="Ej. Menudo National 5 cajas"/>
          </div>
        </div>

        <div class="btns">
          <button class="btn" id="btnGuardar">Guardar movimiento</button>
          <button class="btnGhost" id="btnLimpiar">Limpiar</button>
        </div>

        <div id="warn" class="muted" style="font-size:12px"></div>
      </div>

      <div class="divider"></div>

      <h2>Cierre del día</h2>
      <div class="muted">Genera resumen del día (Entradas, Ventas, Devoluciones y neto por producto).</div>
      <div class="btns">
        <button class="btn2" id="btnCierre">Generar cierre</button>
        <button class="btnGhost" id="btnCopiar">Copiar texto</button>
      </div>
      <textarea id="cierreOut" placeholder="Aquí aparece el cierre del día..." style="margin-top:10px; min-height:180px"></textarea>
    </aside>

  </div>

  <!-- KARDEX -->
  <section class="card">
    <div class="flex">
      <div>
        <h2>Kardex (movimientos)</h2>
        <div class="muted">Historial completo. Puedes filtrar por fecha.</div>
      </div>
      <div class="row2" style="max-width:520px; width:100%">
        <div>
          <label>Desde</label>
          <input id="fromDate" type="date"/>
        </div>
        <div>
          <label>Hasta</label>
          <input id="toDate" type="date"/>
        </div>
      </div>
    </div>

    <div style="margin-top:12px; overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Unidad</th>
            <th class="right">Cantidad</th>
            <th>Referencia</th>
            <th class="right">Acción</th>
          </tr>
        </thead>
        <tbody id="movTbody">
          <tr><td colspan="7" class="muted">Sin movimientos.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<div class="toast" id="toast">Listo</div>

<script>
/* =========================
   VDC MVP — Inventario Mostrador
   - Sin Supabase: guarda en localStorage
   - Modelado:
     inv: { "producto|unidad": {producto, unidad, existencia} }
     movs: [{id, fecha, tipo, producto, unidad, qty, ref, notas, ts}]
   ========================= */

const LS_KEY = "vdc_mostrador_mvp_v1";

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1800);
}

function todayISO(){
  const d = new Date();
  const tzOff = d.getTimezoneOffset()*60000;
  return new Date(d - tzOff).toISOString().slice(0,10);
}

function nowStamp(){
  return new Date().toISOString();
}

function norm(s){
  return (s||"").toString().trim();
}
function keyOf(prod, unidad){
  return `${norm(prod).toLowerCase()}|${norm(unidad).toLowerCase()}`;
}
function prettyTipo(t){
  if(t==="entrada") return {txt:"Entrada", cls:"tag tagIn"};
  if(t==="venta") return {txt:"Venta", cls:"tag tagOut"};
  if(t==="devolucion") return {txt:"Devolución", cls:"tag tagIn"};
  return {txt:"Ajuste", cls:"tag tagAdj"};
}

let state = {
  inv: {},     // map
  movs: []     // array
};

function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{
      state = JSON.parse(raw);
      if(!state.inv) state.inv = {};
      if(!state.movs) state.movs = [];
    }catch(e){
      state = {inv:{}, movs:[]};
    }
  }
  updatePills();
  renderAll();
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  updatePills();
}
function updatePills(){
  $("todayPill").textContent = `Fecha: ${$("fecha").value || todayISO()}`;
  const last = localStorage.getItem(LS_KEY) ? "sí" : "—";
  $("lastSavePill").textContent = `Guardado: ${last==="sí" ? "OK" : "—"}`;
}

function applyMovementToInv(m){
  const k = keyOf(m.producto, m.unidad);
  if(!state.inv[k]){
    state.inv[k] = { producto: norm(m.producto), unidad: norm(m.unidad), existencia: 0 };
  }
  const item = state.inv[k];
  const q = Number(m.qty)||0;

  // Reglas:
  // entrada: suma
  // devolucion: suma
  // venta: resta
  // ajuste: puede ser positivo o negativo (se aplica tal cual)
  if(m.tipo==="entrada" || m.tipo==="devolucion"){
    item.existencia += q;
  }else if(m.tipo==="venta"){
    item.existencia -= q;
  }else if(m.tipo==="ajuste"){
    item.existencia += q;
  }

  // redondeo suave (evita 0.3000000004)
  item.existencia = Math.round(item.existencia * 1000) / 1000;

  // si queda casi cero, lo dejamos en 0
  if(Math.abs(item.existencia) < 0.0005) item.existencia = 0;

  // si ya no hay existencia y es 0, lo podemos mantener (para historial)
}

function rebuildInventoryFromMovs(){
  state.inv = {};
  for(const m of state.movs){
    applyMovementToInv(m);
  }
}

function addMovement(m){
  state.movs.unshift(m); // newest first
  applyMovementToInv(m);
  save();
  renderAll();
}

function deleteMovement(id){
  state.movs = state.movs.filter(x=>x.id !== id);
  rebuildInventoryFromMovs();
  save();
  renderAll();
}

function filteredInventory(){
  const q = norm($("searchInput").value).toLowerCase();
  const u = $("unitFilter").value;
  const arr = Object.values(state.inv)
    .filter(it => {
      const matchQ = !q || it.producto.toLowerCase().includes(q);
      const matchU = !u || it.unidad.toLowerCase() === u;
      return matchQ && matchU;
    })
    .sort((a,b)=> a.producto.localeCompare(b.producto));
  return arr;
}

function inventoryTbodyRow(it){
  const existencia = Number(it.existencia)||0;
  const danger = existencia < 0 ? `<span class="dangerText">(${existencia.toFixed(2)})</span>` : `${existencia.toFixed(2)}`;
  return `
    <tr>
      <td><b>${escapeHtml(it.producto)}</b></td>
      <td>${escapeHtml(it.unidad)}</td>
      <td class="right">${danger}</td>
      <td class="right">
        <button class="btnGhost mini" onclick="quick('venta','${jsStr(it.producto)}','${jsStr(it.unidad)}',1)">-1</button>
        <button class="btnGhost mini" onclick="quick('venta','${jsStr(it.producto)}','${jsStr(it.unidad)}',2)">-2</button>
        <button class="btnGhost mini" onclick="quick('entrada','${jsStr(it.producto)}','${jsStr(it.unidad)}',1)">+1</button>
      </td>
    </tr>
  `;
}

function filteredMovs(){
  const from = $("fromDate").value;
  const to = $("toDate").value;
  return state.movs.filter(m=>{
    if(from && m.fecha < from) return false;
    if(to && m.fecha > to) return false;
    return true;
  });
}

function movTbodyRow(m){
  const t = prettyTipo(m.tipo);
  return `
    <tr>
      <td>${escapeHtml(m.fecha)}</td>
      <td><span class="${t.cls}">${t.txt}</span></td>
      <td>${escapeHtml(m.producto)}</td>
      <td>${escapeHtml(m.unidad)}</td>
      <td class="right"><b>${Number(m.qty).toFixed(2)}</b></td>
      <td class="muted">${escapeHtml(m.ref || "")}</td>
      <td class="right">
        <button class="btnDanger mini" onclick="delMov('${m.id}')">Borrar</button>
      </td>
    </tr>
  `;
}

function renderInventory(){
  const arr = filteredInventory();

  const withStock = arr.filter(it => (Number(it.existencia)||0) !== 0).length;
  $("kpiSkus").textContent = withStock;

  const cajas = arr
    .filter(it => it.unidad.toLowerCase() === "caja")
    .reduce((acc,it)=> acc + (Number(it.existencia)||0), 0);
  $("kpiCajas").textContent = (Math.round(cajas*100)/100).toFixed(2);

  // movimientos hoy
  const hoy = $("fecha").value || todayISO();
  const movsHoy = state.movs.filter(m=>m.fecha===hoy).length;
  $("kpiMovs").textContent = movsHoy;

  if(arr.length===0){
    $("invTbody").innerHTML = `<tr><td colspan="4" class="muted">Sin datos aún. Registra una entrada o carga demo.</td></tr>`;
    return;
  }
  $("invTbody").innerHTML = arr.map(inventoryTbodyRow).join("");
}

function renderMovs(){
  const arr = filteredMovs();
  if(arr.length===0){
    $("movTbody").innerHTML = `<tr><td colspan="7" class="muted">Sin movimientos en este rango.</td></tr>`;
    return;
  }
  $("movTbody").innerHTML = arr.map(movTbodyRow).join("");
}

function renderAll(){
  renderInventory();
  renderMovs();
}

function validateForm(){
  const f = $("fecha").value;
  const tipo = $("tipo").value;
  const prod = norm($("producto").value);
  const unidad = $("unidad").value;
  const qty = Number($("qty").value);

  if(!f) return "Selecciona fecha.";
  if(!prod) return "Escribe el producto.";
  if(!unidad) return "Selecciona unidad.";
  if(!(qty>0) && tipo!=="ajuste") return "Cantidad debe ser > 0.";
  if(tipo==="ajuste" && !isFinite(qty)) return "En ajuste, la cantidad puede ser positiva o negativa (ej. -1).";

  // Warning si va a quedar negativo
  const k = keyOf(prod, unidad);
  const cur = state.inv[k] ? Number(state.inv[k].existencia)||0 : 0;
  if(tipo==="venta" && qty>cur){
    return `Ojo: estás vendiendo más de lo disponible (${cur.toFixed(2)}). Se permitirá, pero quedará negativo.`;
  }
  return "";
}

function clearForm(){
  $("tipo").value = "entrada";
  $("producto").value = "";
  $("unidad").value = "caja";
  $("qty").value = "";
  $("ref").value = "";
  $("notas").value = "";
  $("warn").textContent = "";
}

function quick(tipo, producto, unidad, qty){
  $("tipo").value = tipo;
  $("producto").value = producto;
  $("unidad").value = unidad;
  $("qty").value = qty;
  $("ref").value = "Acción rápida";
  $("notas").value = "";
  $("btnGuardar").click();
}

window.quick = quick;

function genId(){
  return "M" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function buildCierre(fecha){
  // agrupa movimientos por producto|unidad y por tipo
  const movs = state.movs.filter(m=>m.fecha===fecha);

  const agg = {}; // key -> {producto, unidad, entrada, venta, devolucion, ajuste, neto}
  for(const m of movs){
    const k = keyOf(m.producto, m.unidad);
    if(!agg[k]){
      agg[k] = {producto:norm(m.producto), unidad:norm(m.unidad), entrada:0, venta:0, devolucion:0, ajuste:0};
    }
    agg[k][m.tipo] = (agg[k][m.tipo]||0) + (Number(m.qty)||0);
  }

  // construir texto
  const lines = [];
  lines.push(`VDC 360° — Cierre Mostrador`);
  lines.push(`Fecha: ${fecha}`);
  lines.push(`----------------------------------`);

  const items = Object.values(agg).sort((a,b)=>a.producto.localeCompare(b.producto));
  if(items.length===0){
    lines.push(`Sin movimientos registrados en este día.`);
    return lines.join("\n");
  }

  for(const it of items){
    const neto = (it.entrada||0) + (it.devolucion||0) + (it.ajuste||0) - (it.venta||0);
    lines.push(`• ${it.producto} (${it.unidad})`);
    if((it.entrada||0) !== 0) lines.push(`   + Entradas: ${fmt(it.entrada)}`);
    if((it.devolucion||0) !== 0) lines.push(`   + Devoluciones: ${fmt(it.devolucion)}`);
    if((it.ajuste||0) !== 0) lines.push(`   ± Ajuste: ${fmt(it.ajuste)}`);
    if((it.venta||0) !== 0) lines.push(`   - Ventas: ${fmt(it.venta)}`);
    lines.push(`   = Neto del día: ${fmt(neto)}`);
  }

  lines.push(`----------------------------------`);
  lines.push(`Movimientos del día: ${movs.length}`);

  return lines.join("\n");
}

function fmt(n){
  return (Math.round((Number(n)||0)*100)/100).toFixed(2);
}

// escape helpers
function escapeHtml(str){
  return (str||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function jsStr(str){
  return (str||"").toString()
    .replaceAll("\\","\\\\")
    .replaceAll("'","\\'")
    .replaceAll('"','\\"');
}

window.delMov = function(id){
  if(confirm("¿Borrar este movimiento?")){
    deleteMovement(id);
    toast("Movimiento borrado");
  }
};

function setDefaultDates(){
  const t = todayISO();
  $("fecha").value = t;
  $("fromDate").value = "";
  $("toDate").value = "";
}

function loadDemo(){
  const t = $("fecha").value || todayISO();
  state = {inv:{}, movs:[]};

  const demo = [
    {fecha:t, tipo:"entrada", producto:"Caja Menudo National", unidad:"caja", qty:5, ref:"Envio AM", notas:""},
    {fecha:t, tipo:"entrada", producto:"Menudo National", unidad:"kg", qty:120, ref:"Envio AM", notas:""},
    {fecha:t, tipo:"venta", producto:"Caja Menudo National", unidad:"caja", qty:2, ref:"Ticket 101", notas:""},
    {fecha:t, tipo:"venta", producto:"Menudo National", unidad:"kg", qty:36.5, ref:"Ticket 102", notas:""},
    {fecha:t, tipo:"devolucion", producto:"Menudo National", unidad:"kg", qty:2.0, ref:"Devolución", notas:""},
    {fecha:t, tipo:"entrada", producto:"Caja Excel", unidad:"caja", qty:3, ref:"Envio PM", notas:""}
  ].map(x=>({ ...x, id:genId(), ts:nowStamp() }));

  state.movs = demo.slice().reverse(); // para que al unshift quede orden
  rebuildInventoryFromMovs();
  save();
  renderAll();
  toast("Demo cargada");
}

function resetAll(){
  if(confirm("Esto borrará TODO el inventario y movimientos (local). ¿Seguro?")){
    state = {inv:{}, movs:[]};
    localStorage.removeItem(LS_KEY);
    save();
    renderAll();
    $("cierreOut").value = "";
    toast("Datos borrados");
  }
}

function copyCierre(){
  const text = $("cierreOut").value || "";
  if(!text.trim()){
    toast("No hay cierre para copiar");
    return;
  }
  navigator.clipboard.writeText(text).then(()=>{
    toast("Cierre copiado");
  }).catch(()=>{
    toast("No se pudo copiar (permiso del navegador)");
  });
}

// Events
$("btnGuardar").addEventListener("click", ()=>{
  const warn = validateForm();
  $("warn").textContent = warn;

  const f = $("fecha").value;
  const tipo = $("tipo").value;
  const prod = norm($("producto").value);
  const unidad = $("unidad").value;
  const qtyVal = Number($("qty").value);

  // bloquear errores duros
  if(!f || !prod || !unidad) return toast("Faltan datos");
  if(tipo!=="ajuste" && !(qtyVal>0)) return toast("Cantidad inválida");
  if(tipo==="ajuste" && !isFinite(qtyVal)) return toast("Cantidad inválida");

  const m = {
    id: genId(),
    fecha: f,
    tipo,
    producto: prod,
    unidad,
    qty: qtyVal,
    ref: norm($("ref").value),
    notas: norm($("notas").value),
    ts: nowStamp()
  };

  addMovement(m);
  toast("Movimiento guardado");
  clearForm();
});

$("btnLimpiar").addEventListener("click", ()=>{
  clearForm();
  toast("Formulario limpio");
});

$("btnCierre").addEventListener("click", ()=>{
  const f = $("fecha").value || todayISO();
  $("cierreOut").value = buildCierre(f);
  toast("Cierre generado");
});

$("btnCopiar").addEventListener("click", copyCierre);

$("btnDemo").addEventListener("click", loadDemo);
$("btnReset").addEventListener("click", resetAll);

$("searchInput").addEventListener("input", renderInventory);
$("unitFilter").addEventListener("change", renderInventory);

$("fromDate").addEventListener("change", renderMovs);
$("toDate").addEventListener("change", renderMovs);

// init
setDefaultDates();
load();
</script>

</body>
</html>
